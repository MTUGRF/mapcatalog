<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>GRF Map Catalog</title>
  <script type="module" src="https://js.arcgis.com/calcite-components/1.0.0-beta.81/calcite.esm.js"></script>
  <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.0-beta.81/calcite.css" />
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">  
  <link rel="stylesheet" href="https://js.arcgis.com/4.23/esri/themes/dark/main.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.10.0/viewer.css" integrity="sha512-tYobxYoCZxl0CejYCA8c4w8HRcg3wRoKaGYIQ/2ILqyB4vRqMd/Jmehxod1dQJ2uE/9rDY9pG48isM8SHEAwDQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.10.0/viewer.js" integrity="sha512-psAniLUS9J4A5KNQiSt9XMNeVSMx/Rz89vQJqeYlOIiTR5WK8zU/8EPwAKt+522eeV04QUzIwX5VrAW10FbdeQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>   
  <script src="https://js.arcgis.com/4.23/"></script>
  <style>
    
    #viewDiv {
      position: absolute;
      top: 0;
      bottom: 0;      
      padding: 0;
      margin-top: 56px;          
      width: 80%;
      left:  20%;
    }
    .navbar {
      height: 56px;
    }
    .navbar-brand {
      padding: 0;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;   
      color: white !important; 
    }
    /*Navbar links*/
    .navbar-light .navbar-nav .nav-link {
      color: #d9dde0;
      font-size: 13px;
    }
    .navbar-light .navbar-nav .nav-link:visited {
      color: #d9dde0;  
    }

    .navbar-light .navbar-nav .nav-link:hover {
      color: white;  
    }

    /*Navbar background color*/
    .bg-light {
      background: black !important;
      border-bottom: solid 2px black;
    }   

    /*Searchbar*/

    /*Search bar container*/
    .container {   
        margin-top: 5px;
        width: 100%;                  
     }

    #search {
      width: 50%;    
      border-radius: 0px 0px 0px 0px;   
      background-color:  black;
      border-color: #767576;
    } 

    .btn-outline-warning {      
      color: #000;
      border-radius: 0px 0px 0px 0px; 
      border-color: #FC0;
      background-color: #FC0;        
    }

    .btn-outline-warning:hover {
      color: #000;
      border-color: #FC0;
      background-color: #FC0;
    }

    .calcite-tutorial {
      --calcite-ui-brand: #FC0;
      --calcite-ui-brand-hover: #008D52;     
    }

    .calcite-tutorial calcite-chip {
      --calcite-ui-foreground-2: var(--calcite-ui-foreground-2);
      --calcite-ui-text-1: #FC0;
      opacity:  1;      
    }  

    #control-reset-el {
      color: #FC0;
    }

     #searchDiv {
      float: right;
      margin:  5px;
      width:  auto;
      border-color: #767576 !important;
    }

    .esri-input {
      border: 1px solid #767576 !important;
    }
    .esri-search__submit-button {
      background-color:  #FC0;
      border:  solid 1px #FC0;
    }

    .esri-search__submit-button:hover {
      background-color:  #FC0;
      border:  solid 1px #FC0;
    }
    
    .esri-icon-search {
      color: black !important;
      font-weight: bold !important;
    }

    h10 {
      color: #FC0;
    }

    h11 {
      font-weight: bolder;
    }

    #image {
  	  display: none;
	}

	.esri-popup__content img {
	  cursor: pointer;
	}

	.viewer-title {
	  color: white;
	  font-size: 14px;
	  opacity: 1; 
	}


    /* Custom scrollbar */
/* width */
::-webkit-scrollbar {
  width: 10px !important;
}

/* Track */
::-webkit-scrollbar-track {
  background: #f1f1f1 !important; 
}
 
/* Handle */
::-webkit-scrollbar-thumb {
  background: #888 !important; 
}

/* Handle on hover */
::-webkit-scrollbar-thumb:hover {
  background: #555 !important; 
}
  </style>
</head>

<body>
  <div class="calcite-theme-dark">
  <nav class="navbar navbar-expand-md navbar-light bg-light">
  <a class="navbar-brand" href="https://mtugrf.github.io/mapcatalog/" target="_blank" rel="noopener">
    <img src="husky.svg" width="50" height="50" class="d-inline-block align-top" alt="">
      &nbsp;Geospatial Research Facility Map Catalog
  </a>
  <div class="collapse navbar-collapse" id="navbarNav" style="">
        <ul class="navbar-nav mr-auto">           
        </ul>
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="https://portal1-geo.sabu.mtu.edu/mtuarcgis/home/" target="_blank" rel="noopener">Geospatial Research Portal</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="https://www.mtu.edu/social-sciences/" target="_blank" rel="noopener">Social Sciences</a>
            </li>           
        </ul>
    </div>
</nav>
  <calcite-shell content-behind class="calcite-tutorial" style="height: auto;margin-top: 56px">
    <calcite-shell-panel slot="primary-panel">       
      <calcite-panel>
<div id="searchDiv"></div>
<div>
  <!-- Default Image for ViewerJS -->
  <img id="image" src="" alt="Picture">
</div>        
   
        <calcite-block heading="Filters" open style="margin-top:0px">
          <calcite-tooltip-manager slot="control">
            <calcite-action disabled icon="filter" id="control-reset-el"></calcite-action>
            <!-- calcite-tooltip reference-element="control-reset-el" position="bottom">
              Reset to defaults
            </calcite-tooltip> -->
          </calcite-tooltip-manager>
          <!-- <calcite-label>
            Georeferenced maps only
            <calcite-radio-group id="control-visited-type-el" width="full">
              <calcite-radio-group-item value="DESC" checked>Yes</calcite-radio-group-item>
              <calcite-radio-group-item value="ASC">No</calcite-radio-group-item>
            </calcite-radio-group>
          </calcite-label> -->
          <calcite-label html-for="georef" layout="inline">
          <calcite-checkbox id="georef" scale="l"></calcite-checkbox> Georeferenced maps only
          </calcite-label>
          <calcite-label>
            Select a Theme
            <calcite-select id="theme">
              <calcite-option label="Choose Theme" value="none" selected="true"></calcite-option>
              <calcite-option label="Fire Insurance Plans" value="Fire Insurance Plans"></calcite-option> 
              <calcite-option label="Land Use" value="Land Use"></calcite-option>
              <calcite-option label="Mining Maps" value="Mining Maps"></calcite-option>
              <calcite-option label="Nautical Charts" value="Nautical"></calcite-option>
              <calcite-option label="Topographic" value="Topographic"></calcite-option>
            </calcite-select>
          </calcite-label>
          <calcite-label>
            Range Between Years
            <!-- <calcite-slider id="control-count-per-state-el"   label-handles max-label="1979" max-value="1979" max="1979" min-value="1883"
            min="1883" ticks="20"></calcite-slider> -->
          </calcite-label>    
          <calcite-input id="startYear" style="width: 45%; display: inline-block"></calcite-input> <h11> - </h11> <calcite-input id="endYear" style="width: 45%; display: inline-block"></calcite-input>      
        <calcite-panel id="resultsDiv">
        <h4 class="heading" id="result-block" slot="header-content" style="font-size: var(--calcite-font-size--1); color: var(--calcite-ui-text-1);">
          Results
        </h4>
          <calcite-list id="result-list"></calcite-list>     
    </calcite-shell-panel>
  </calcite-shell>
</div>

  <div id="viewDiv"></div>
</body>

<script>

  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/symbols/WebStyleSymbol",
    "esri/Basemap",
    "esri/rest/support/TopFeaturesQuery",
    "esri/rest/support/TopFilter",
    "esri/widgets/Home",
    "esri/widgets/Search"
  ], (Map, MapView, FeatureLayer, WebStyleSymbol, Basemap, TopFeaturesQuery, TopFilter, Home, Search) => (async () => {

    // Create a style for the indexLayer
   const renderer = {
      type: "simple",  // autocasts as new SimpleRenderer()
      symbol: {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [ 255, 128, 0, 0 ],
        outline: {  // autocasts as new SimpleLineSymbol()
          width: 1,
          color: "black"
        }
      }
    }; 

    const layer = new FeatureLayer({
      url:
        "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/Spatial_Indexes_for_Map_Catalog/FeatureServer/0",
      outFields: ["*"],
      renderer: renderer,  
      maxScale: 24,
      minScale: 0    
    });

    const map = new Map({
      basemap: "streets-navigation-vector",
      layers: [layer]
    });

    const view = new MapView({
      container: "viewDiv",
      map: map,
      center: [-88.5694, 47.1211],
      zoom: 7,
      highlightOptions: {
      color: [255,204,0] // color of the highlight when a feature is selected
      },
    });

    let homeWidget = new Home({
      view: view
    });

    view.ui.add(homeWidget, "top-left");
    view.ui.move("zoom", "top-left");

    var searchWidget = new Search({
        view: view,
        container: "searchDiv",
        allPlaceholder: "Search maps by keyword",
        includeDefaultSources: false,
        locationEnabled: false,
        sources: []
      });
    const layerView = await view.whenLayerView(layer);

      
      // Create a template for the popup
      var template = {
      // autocasts as new PopupTemplate()
      title: "<font color='#FC0'>{title}",        
      content: [     
            {
          type: "media",
          mediaInfos: [
            {
              title: "",
              type: "image",
              value: {sourceURL: 'https://portal1-geo.sabu.mtu.edu/images/historic_images/' + '{filename}' + '.jpg'}
            }
          ]        
            },{
          type: "fields",
          fieldInfos: [
            {
              fieldName: "datapub",
              label: "Date"
            },
            {
              fieldName: "publisher",
              label: "Publisher"
            },
            {
              fieldName: "filename",
              label: "File Name"
            },
             {
              fieldName: "digHold",
              label: "File Path"
            },
            {
              fieldName: "theme",
              label: "Theme"
            },
            {
              fieldName: "scale",
              label: "Scale"
            },
            {
              fieldName: "source",
              label: "Source"
            },
            {
              fieldName: "title",
              label: "title"
            },
            {
              fieldName: "portalUrl",
              label: "PortalUrl"
            },
            {
              fieldName: "resolution",
              label: "Resolution (dpi)"
            },            
          ]
        }, 
      ]
    };

function setFeatureLayerFilter(expression) {
  layer.definitionExpression = expression;  
}    

view.watch("zoom", function(newValue) {
  //var series = $('#setFilter').val();
  if (newValue < 6) {
    // at low zooms levels show all charts
    setFeatureLayerFilter("Shape__Area < ‎2206130383567.0");
  } else if (newValue >= 6 && newValue < 8) {    
    // as the users zooms in show only larger scale charts
    setFeatureLayerFilter("Shape__Area < ‎471268823086"); 
  } else if (newValue >= 8 && newValue < 9) {
    setFeatureLayerFilter("Shape__Area < 154059814175");
  }  else if (newValue >= 9 && newValue < 10) {
    setFeatureLayerFilter("Shape__Area <‎ 20523650608");
  } else if (newValue >= 10 && newValue < 11) {
    setFeatureLayerFilter("Shape__Area < 6069706367");
  } else if (newValue >= 11 && newValue < 12) {
    setFeatureLayerFilter("Shape__Area < 21000000");
  } else if (newValue >= 12 && newValue < 14) {
    setFeatureLayerFilter("Shape__Area < 12000000");
  } else if (newValue > 14) {
    setFeatureLayerFilter("Shape__Area < 2000000");
  }
  //console.log("scale property changed: ", newValue);
});

    // Set the popup template on the layer
    layer.popupTemplate = template;     
     

   // const controlVisitedTypeEl = document.getElementById("control-visited-type-el");
    const controlThemeEl = document.getElementById("theme");
    const controlGeoEl = document.getElementById("georef");
    const controlYearEl = document.getElementById("endYear");
   //const controlCountPerStateEl = document.getElementById("control-count-per-state-el");
    const controlResetEl = document.getElementById("control-reset-el");

  //  controlVisitedTypeEl.addEventListener("calciteRadioGroupChange", async (event) => { orderBy = event.target.value, filterItems() });
    controlThemeEl.addEventListener("calciteSelectChange", async (event) => { theme = event.target.value, filterItems() });
    controlGeoEl.addEventListener("calciteCheckboxChange", async (event) => { georef = event.target.value, filterItems() });
    controlYearEl.addEventListener("calciteInputChange", async (event) => {
     var startYearVal = $("#startYear").val();
     var endYearVal = $("#startYear").val();
     if (startYearVal != "" && endYearVal != "") {     
     year = event.target.value, filterItems()
     } 
   });
    
  //  controlCountPerStateEl.addEventListener("calciteSliderChange", async (event) => { count = event.target.value, filterItems() });
 //   controlResetEl.addEventListener("click", async () => resetFilters());

    // When the user clicks the search button filter features
    $( ".esri-search__submit-button" ).click(function() {
      filterItems();    
    });

    // When the user clicks the clear button query all features
    $(document).on('click','.esri-search__clear-button', function(){   	
    	var searchVal = $( "#searchDiv-input" ).val();	
    	if (searchVal != '') {
    		$( "#searchDiv-input" ).val("");
    		console.log(searchVal);
    		filterItems();
    	}     
 	}); 

	// if users hits enter perform the search   
	$( ".esri-input" ).keyup(function(event) {
	    // Number 13 is the "Enter" key on the keyboard
	    if (event.keyCode === 13) {
	      // Cancel the default action, if needed
	      event.preventDefault();
	      // Trigger the button element with a click
	      $( ".esri-search__submit-button" ).click();
	    }        
	 });    

    const countDefault = 1;
    const orderByDefault = "DESC"
    const yearDefault = "TOTAL"

    let count = countDefault;
    let orderBy = orderByDefault;
    let year = yearDefault;

    async function filterItems() {
      view.popup.close();
      // Create an empty array of search strings
      var searchStrings = [];
      var searchVal = $( "#searchDiv-input" ).val();
      var themeVal = $("#theme").val();
      var startYearVal = $("#startYear").val();
      var endYearVal = $("#endYear").val();
      console.log(searchVal, themeVal);
      let query = layer.createQuery();
      query.returnGeometry = true;
      if (searchVal != '') {
        var searchValString = "(Upper(title) LIKE '%" + searchVal.toUpperCase() + "%' OR Upper(tags) LIKE '%"+ searchVal.toUpperCase() + "%' OR datapub LIKE '%" + searchVal + "')"; 
        searchStrings.push(searchValString);            
      } /*else if (searchVal == '') {
      	query.where = "1=1";
      } */

      if (themeVal != 'none') {
      	var themeString = "theme = '" + themeVal + "'";
        searchStrings.push(themeString);
      }    

      if ($('#georef').prop("checked")) {
        var geoString = "georef = 'Yes'";
        searchStrings.push(geoString);
      }

      if (startYearVal != "" && endYearVal != "") {     
        var yearString = "datapub BETWEEN " + "'" + startYearVal + "' AND " + "'" + endYearVal + "'";
        searchStrings.push(yearString);
      } 
      // Create a query string from the searchStrings array
      var queryString = searchStrings.join(" AND ");
      // Execute the query from the query string
      query.where = queryString;

      document.getElementById("result-list").innerHTML = "";
      document.getElementById("result-block").open = true;

      const results = await layer.queryFeatures(query);
      graphics = results.features;    

      // Zoom to the result of the features
      if (graphics.length > 0) {
        var extent = results.features[0].geometry.extent;
        results.features.forEach(function(feature) {
            extent = extent.union(feature.geometry.extent);
        })

        view.goTo({ center: extent.expand(1.3) }, { duration: 400 }); 
   	  }

      document.getElementById("result-block").innerHTML = "Results (<h10>" + graphics.length + "</h10>)"; 

      graphics.forEach((result, index) => {
        const attributes = result.attributes;        
        const item = document.createElement("calcite-list-item");
        const chip = document.createElement("calcite-chip");
        const icon = document.createElement("calcite-icon");
        icon.icon = "arrowLeft";
        icon.scale = "s";        
        chip.scale = "s";
        chip.innerText = "";
        chip.icon = "map";
        chip.icon.className = "icon-class";
        chip.slot = "content-end";        
        item.label = attributes.title;
        item.value = index;
        item.description = attributes.datapub;
        item.addEventListener("click", () => resultClickHandler(result, index));
        item.appendChild(chip);       
        document.getElementById("result-list").appendChild(item);
      });

      query.orderByFields = [""];
      const objectIds = await layer.queryObjectIds(query);
      layerView.filter = { objectIds };

     // determineResetActionState();
    }

    function resultClickHandler(result, index) {
      const popup = graphics && graphics[parseInt(index, 10)];
      if (popup) {
        view.popup.open({
          features: [popup],
          location: result.geometry.centroid
        });       
        const extent = result.geometry.extent;
        // when clicking on a record zoom to its extent
        view.goTo({ center: extent.expand(6) }, { duration: 400 });

      }
      var thumbUrl = result.attributes.filename;
      var itemTitle = result.attributes.title;
      updateViewer();
    };

    function updateViewer() {
      var thumbUrl = view.popup.selectedFeature.attributes.filename; 
      var itemTitle = view.popup.selectedFeature.attributes.title; 
      document.getElementById('image').src='https://portal1-geo.sabu.mtu.edu/images/historic_images/' + thumbUrl + '.jpg';
      document.getElementById('image').alt=itemTitle;    
      viewer.update();
    }

    function determineResetActionState() {
      if (searchVal =! '') {
        controlResetEl.removeAttribute("disabled");
        controlResetEl.indicator = true;
      }
      else {
        controlResetEl.disabled = true;
        controlResetEl.removeAttribute("indicator");
      }
    }

    function resetFilters() {
      count = countDefault;
      orderBy = orderByDefault;
      year = yearDefault;

      const activeRadioGroupItem = document.querySelector(`calcite-radio-group-item[value=${orderByDefault}]`)
      activeRadioGroupItem.checked = true;
      controlYearEl.value = yearDefault;
      controlCountPerStateEl.value = countDefault;

      filterItems();
    }

     // setup a new viewer to display the map scans
    var viewer = new Viewer(document.getElementById('image'), {
      navbar: false,
      inline: false,
      toolbar: {
        zoomIn: 1,
        zoomOut: 1,
        oneToOne: 1,
        reset: 1,
        prev: 0,
        play: {
          show: 1,
          size: 'large',
        },
        next: 0,
        rotateLeft: 1,
        rotateRight: 1,
        flipHorizontal: 1,
        flipVertical: 1,
      },
      viewed() {
        //viewer.zoomTo(1);
      },
    });  

    // Remove the zoom-to popup action
//     view.popup.actions = []; 

    /*// Actions for the popup
    var requestAction = {
      // This text is displayed as a tooltip
      title: "Request Item",
      // The ID by which to reference the action in the event handler
      id: "req-item",
      // Sets the icon font used to style the action button
      className: "esri-icon-launch-link-external"
    };
    // Adds the custom action to the popup.
    view.popup.actions.push(requestAction);

    // This event fires for each click on any action
    view.popup.on("trigger-action", function(event){
      // If the request item button is clicked launch the Google form
      if(event.action.id === "req-item"){
        // Get the file name from the current popup
        var title = view.popup.selectedFeature.attributes.title;
        var id = view.popup.selectedFeature.attributes.fid;
        window.open(
                  'https://docs.google.com/forms/d/e/1FAIpQLSeF2x2DCePE_m6HRsUSsf6pFaEhnMN-4cc3C79OFpvSIRv1mA/viewform?usp=pp_url&entry.1039013080=' + title + '(' + id + ')','"_blank"');
      }
    });  */

  // when the user clicks the thumbnail, open the viewer
  $(document).on('click','.esri-popup__content img', function(){   	
    updateViewer();
    viewer.show();
  });

  view.on("click", (event) => {
  // only include graphics from the layer in the hitTest
  const opts = {
    include: layer
  }
  // check for a click on the index layer
  view.hitTest(event, opts).then((response) => {
    // check if a feature is returned from the index layer
    if (response.results.length) {
      const graphic = response.results[0].graphic; 
    }    
  });
});
    filterItems();
  })());
</script>

</html>
